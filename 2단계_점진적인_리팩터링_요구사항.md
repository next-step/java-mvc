# ğŸš€ 2ë‹¨ê³„ - ì ì§„ì ì¸ ë¦¬íŒ©í„°ë§

## ë¯¸ì…˜ ì„¤ëª…
ìƒˆë¡œìš´ MVC í”„ë ˆì„ì›Œí¬ë¥¼ ì¶”ê°€í•˜ë©´ ê¸°ì¡´ì— êµ¬í˜„í•œ ì»¨íŠ¸ë¡¤ëŸ¬ ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ MVC í”„ë ˆì„ì›Œí¬ë¡œ ë§Œë“  ì»¨íŠ¸ë¡¤ëŸ¬ë„ ë³€ê²½ í•´ì•¼ í• ê¹Œ?
ì‹¤ìŠµ ì½”ë“œëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ì˜ ê°¯ìˆ˜ê°€ ì ê³  ì‹œìŠ¤í…œ ì˜í–¥ë„ íŒŒì•…ì´ ì–´ë µì§€ ì•Šê³  ê¸ˆë°© ë°”ê¿€ ìˆ˜ ìˆë‹¤.
í•˜ì§€ë§Œ ì‹¤ì œ ì„œë¹„ìŠ¤ ë˜ëŠ” í”„ë¡œë•ì…˜ ì½”ë“œëŠ” ë³µì¡í•˜ê³  ì˜í–¥ ë²”ìœ„ê°€ í›¨ì”¬ í¬ë‹¤.
ìˆ˜ë°± ê°œì—ì„œ ìˆ˜ì²œ ê°œì˜ í´ë˜ìŠ¤ë¥¼ ë³€ê²½í•´ì•¼ ë  ìˆ˜ë„ ìˆë‹¤.
ë³€ê²½ì´ ì‰½ì§€ ì•Šê¸° ë•Œë¬¸ì— ê¸°ì¡´ ì½”ë“œë¥¼ ìœ ì§€í•˜ë©´ì„œ ì‹ ê·œ ê¸°ëŠ¥ì„ ì¶”ê°€í•´ì•¼ í•œë‹¤.

## ê¸°ëŠ¥ ìš”êµ¬ì‚¬í•­

### Legacy MVC ì™€ @MVC í†µí•©í•˜ê¸°
ì»¨íŠ¸ë¡¤ëŸ¬ ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜ MVC í”„ë ˆì„ì›Œí¬ì™€ @MVC í”„ë ˆì„ì›Œí¬ê°€ ê³µì¡´í•˜ë„ë¡ ë§Œë“¤ì.
ì˜ˆë¥¼ ë“¤ë©´, íšŒì›ê°€ì… ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì•„ë˜ì²˜ëŸ¼ ì–´ë…¸í…Œì´ì…˜ ê¸°ë°˜ ì»¨íŠ¸ë¡¤ëŸ¬ë¡œ ë³€ê²½í•´ë„ ì •ìƒ ë™ì‘í•´ì•¼ í•œë‹¤.
```java
@Controller
public class RegisterController {

    @RequestMapping(value = "/register", method = RequestMethod.POST)
    public ModelAndView save(HttpServletRequest req, HttpServletResponse res) {
        ...
    }

    @RequestMapping(value = "/register", method = RequestMethod.GET)
    public ModelAndView show(HttpServletRequest req, HttpServletResponse res) {
        ...
    }
}
```

## íŒíŠ¸

### AnnotationHandlerMapping í´ë˜ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨
![img.png](img.png)

### AnnotationHandlerMapping í´ë˜ìŠ¤ì˜ initialize ë©”ì„œë“œëŠ” ì–´ë–¤ ì‘ì—…ì´ í•„ìš”í• ê¹Œ?
### ControllerScanner í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•˜ì
```text
ControllerScannerì—ê²Œ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì°¾ì•„ì„œ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±í•˜ëŠ” ì—­í• ì„ ë§¡ê¸´ë‹¤.
```

1. Reflections ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•œë‹¤.
2. Reflections ê°ì²´ë¡œ @Controller ê°€ ì„¤ì •ëœ ëª¨ë“  í´ë˜ìŠ¤ë¥¼ ì°¾ëŠ”ë‹¤.

```java
Reflections reflections = new Reflections("camp.nextstep.controller");
Set<Class<?>> controllers = reflections.getTypesAnnotatedWith(Controller.class);
```

3. ê° í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•œë‹¤.

```java
final Map<Class<?>, Object> controllers = new HashMap<>();
// ë¦¬í”Œë™ì…˜ í…ŒìŠ¤íŠ¸ì—ì„œ Classë¡œ ì–´ë–»ê²Œ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ”ì§€ ì°¸ê³ í•˜ì
```

### ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ë©”ì„œë“œ ì •ë³´ë¡œ HandlerExecution ì„ ìƒì„±í•œë‹¤.
```text
ìŠ¤ìº”í•œ ì»¨íŠ¸ë¡¤ëŸ¬ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ Map<HandlerKey, HandlerExecution> handlerExecutionsì„ ìƒì„±í•œë‹¤.
```

1. ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë©”ì„œë“œ ì •ë³´ëŠ” ì–´ë–»ê²Œ ê°€ì ¸ì˜¬ê¹Œ?
- @RequestMappingì´ ë¶™ì–´ìˆëŠ” ë©”ì„œë“œ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì•¼ í•œë‹¤.
```java
ReflectionUtils.getAllMethods(class, ReflectionUtils.withAnnotation(RequestMapping.class))
```

2. ê°€ì ¸ì˜¨ ë©”ì„œë“œì—ì„œ @RequestMappingì˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ HandlerKey ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.
```java
final RequestMapping requestMapping = method.getAnnotation(RequestMapping.class);
```

```java
// RequestMappingìœ¼ë¡œë¶€í„° HandlerKey ê°ì²´ì— URLê³¼ HTTP methodë¥¼ ì €ì¥í•œë‹¤.
new HandlerKey(requestMapping.value(), requestMapping.method())
```

3. HandlerExecutionë„ ìƒì„±í•˜ì
- HandlerKeyì— ë§¤í•‘ë˜ëŠ” ë©”ì„œë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ì—­í• ì„ ë§¡ê¸´ë‹¤.
- HandlerExecutionëŠ” ì‹¤í–‰í•  ë©”ì„œë“œì˜ ì¸ìŠ¤í„´ìŠ¤ì™€ ì‹¤í–‰í•  ë©”ì„œë“œë¥¼ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¡œ ê°–ëŠ”ë‹¤.

### DispatcherServlet í´ë˜ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨
![img_1.png](img_1.png)

ë¯¸ì…˜ ìš”êµ¬ì‚¬í•­ì— ë”°ë¥´ë©´ AnnotationHandlerMappingë¥¼ êµ¬í˜„í•˜ëŠ” ë™ì•ˆ ManualHandlerMappingë„ ìœ ì§€í•´ì•¼ í•œë‹¤.
ì–´ë–»ê²Œ ë‘ í´ë˜ìŠ¤ë¥¼ í†µí•©ì‹œí‚¬ ê²ƒì¸ê°€?

### HandlerMapping ì¸í„°í˜ì´ìŠ¤
RequestMapping, AnnotationHandlerMappingì€ ìš”ì²­ URLê³¼ ì‹¤í–‰í•  ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ ë˜ëŠ” ë©”ì†Œë“œë¥¼ ë§¤í•‘í•˜ëŠ” ì—­í• ì€ ê°™ë‹¤.
ë‹¨ì§€ ë‹¤ë¥¸ ì ì´ë¼ë©´ RequestMappingì€ ê°œë°œìê°€ ìˆ˜ë™ìœ¼ë¡œ ë“±ë¡í•˜ê³ , AnnotationHandlerMappingì€ ì• ë…¸í…Œì´ì…˜ì„ ì„¤ì •í•˜ë©´ ìë™ìœ¼ë¡œ ë§¤í•‘í•œë‹¤ëŠ” ì ì´ë‹¤.
ë‘ í´ë˜ìŠ¤ì˜ ê³µí†µëœ ë¶€ë¶„ì„ ì¸í„°í˜ì´ìŠ¤ë¡œ ì¶”ìƒí™”í•œë‹¤.

HandlerMapping ì´ë¦„ìœ¼ë¡œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤.
DispatcherServletì˜ ì´ˆê¸°í™” ê³¼ì •ì—ì„œ ManualHandlerMapping, AnnotationHandlerMappingì„ ëª¨ë‘ ì´ˆê¸°í™”í•œë‹¤. ì´ˆê¸°í™”í•œ 2ê°œì˜ HandlerMappingì„ Listë¡œ ê´€ë¦¬í•œë‹¤.

```java
public interface HandlerMapping {
    Object getHandler(HttpServletRequest request);
}
```

### HandlerAdapter ì¸í„°í˜ì´ìŠ¤
AnnotationHandlerMapping ë˜ëŠ” ManualHandlerMapping í´ë˜ìŠ¤ì—ì„œ ì°¾ì€ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì‹¤í–‰í•´ì•¼ í•œë‹¤.
ìš”ì²­ URLì— ë”°ë¼ AnnotationHandlerMappingì€ HandlerExecutionì„ ë°˜í™˜í•˜ê³  ManualHandlerMappingëŠ” Controllerë¥¼ ë°˜í™˜í•œë‹¤. ê·¸ë¦¬ê³  ë‘˜ë‹¤ ë©”ì„œë“œë¥¼ ì‹¤í–‰í•œë‹¤.

```java
Object handler = getHandler(req);
if (handler instanceof Controller) {
    ModelAndView mav = ((Controller)handler).execute(req, resp);
} else if (handler instanceof HandlerExecution) {
    ModelAndView mav = ((HandlerExecution)handler).handle(req, resp);
} else {
    // throw exception
}
```

---

## ìš”êµ¬ì‚¬í•­ ì •ë¦¬

[x] ControllerScanner í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤
[x] controllers ë¥¼ ì¼ê¸‰ì»¬ë ‰ì…˜ìœ¼ë¡œ ë§Œë“¤ì–´ì„œ ê´€ë¦¬í•œë‹¤
[x] HandlerMapping ê³µí†µ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ RequestMapping, AnnotationHandlerMapping ì„ ê´€ë¦¬í•œë‹¤
    [x] 2ê°œì˜ HandlerMapping í´ë˜ìŠ¤ë¥¼ HandlerMapping ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ì²´ë¡œ ìˆ˜ì •í•œë‹¤
    [ ] ì´ˆê¸°í™” ë©”ì„œë“œì—ì„œ 2ê°œì˜ HandlerMapping ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ê´€ë¦¬í•œë‹¤
    [ ] HandlerMappingRegistry ë¥¼ ì¶”ê°€í•œë‹¤.
[ ] HandlerAdapter ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¶”ê°€í•œë‹¤
    [ ] HandlerAdapterRegistry ë¥¼ ì¶”ê°€í•œë‹¤
    [ ] ìš”ì²­ URL ì— ë”°ë¼ AnnotationHandlerMapping ì€ HAndlerExecution, ManualHandlerMapping ì€ Controller ë¥¼ ë°˜í™˜í•˜ê³  ë©”ì„œë“œë¥¼ ì‹¤í–‰í•˜ë„ë¡ êµ¬í˜„í•œë‹¤
